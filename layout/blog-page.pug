extends /layout/bootstrap5

block beforehtml
  -
    title = post.matter.data?.title ?? title
    description = post.matter.data?.description ?? description
    ogImage = post.ogImage ?? ogImage
    ogImageHeight = _.find(post.matter.data?.meta, { property: 'og:image:height' })?.content ?? ogImageHeight
    ogImageWidth = _.find(post.matter.data?.meta, { property: 'og:image:width' })?.content ?? ogImageWidth
    //- expose variables to browser
    pageExport = { baseurl, markdownit, post, relatedPosts: (relatedPosts || []), site }
    pageExportBase64 = Buffer.from(JSON5.stringify(pageExport)).toString('base64url')

block style
  link(rel="stylesheet" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.css")
  style
    :sass
      [v-cloak]
        display: none
      .blog-body
        font-weight: 300
        :last-child
          margin-bottom: 0 !important
        ol, ul
          padding-left: 1rem
        img
          border-radius: 0.375rem
          box-shadow: var(--bs-box-shadow)
          display: block
          margin-bottom: 1rem
          margin-top: 1rem
          max-width: 100%
          width: 100%
        h1, .h1
          font-size: 24px
          margin-bottom: 1.5rem
          text-align: center
        :not(h2, h3, h4, h5, h6, .h2, .h3, .h4, .h5, .h6) + :is(h2, h3, h4, h5, h6, .h2, .h3, .h4, .h5, .h6)
          margin-top: .8em
        a
          text-decoration: none
        a.header-anchor
          -webkit-user-select: none
          font-size: .8em
          font-weight: 100
          letter-spacing: -1px
          margin-right: .5rem
          user-select: none
        iframe, object, embed
          width: 100%
        blockquote
          border-left: 5px var(--bs-border-style) var(--bs-border-color) !important
          color: rgba(var(--bs-secondary-rgb), var(--bs-text-opacity))
          padding-left: 1rem
          padding: 0 1em
        details
          margin-bottom: 1rem

block content
  #app
    nav-bar(baseurl=baseurl)
    .container.p-3.pb-5(v-cloak)
      .card.shadow
        .card-header
          .d-flex.gap-3.justify-content-center.align-items-center
            img.svgmask.rounded-circle.fs-30px.border.border-1(src=site.gravatar)
            .d-flex.gap-3.fs-16px
              .fw-bold.ls-1px 戴均民
              .vr
              .blog-date.fw-light {{ blogDate }}
        .card-body.px-4.py-3: .blog-body !{ post.markdownit.html }
        .card-footer
          .blog-tags.d-flex.flex-wrap.gap-1.justify-content-center(v-if="page.post.tags?.length")
            a.btn.btn-sm.btn-light.text-body-secondary.bg-body-secondary.rounded-pill(:href="getBlogTagUrl(tag)", v-for="tag of page.post.tags", :key="tag") {{ tag }}
      section.related-posts.mt-5(v-if="page.relatedPosts.length")
        .text-center.fs-14px YOU MAY ALSO LIKE
        .row.row-cols-1.row-cols-lg-3.g-4
          .col(v-for="post, postIdx of page.relatedPosts" :key="post.path"): .card.h-100.shadow
            img.card-img-top(v-if="post.matter.data?.image" :src="post.matter.data?.image" :alt="post.matter.data?.title")
            .card-body.border-top.d-flex.flex-column
              h5.card-title.fs-16px.fw-bold.mb-0 {{ post.matter.data?.title }}
              .card-text.flex-fill.fs-12px.mt-3 {{ post.matter.data?.content }}
  include /layout/bootstrap5-navbar-content

block script
  script(type="module").
    // https://bracia.netlify.app/that-which-does-not-kill-us-makes-us-stronger
    import _ from 'lodash'
    import { Buffer } from '@taichunmin/buffer'
    import { computed, createApp, onMounted, ref, reactive } from 'vue'
    import { dayjs } from '@app/js/dayjs.mjs'
    import JSON5 from 'json5'
    import mermaid from 'mermaid'
    import NavBar from '@app/js/bootstrap5-navbar.mjs'
    import PhotoSwipe from 'photoswipe'

    mermaid.initialize({ startOnLoad: false })

    const pageExportBase64 = "!{pageExportBase64}"
    window.vm = createApp({
      components: { NavBar },
      setup () {
        const page = reactive(JSON5.parse(Buffer.from(pageExportBase64, 'base64url').toString()))

        function getBlogTagUrl (tag) {
          const tmp = new URL('./', location)
          tmp.searchParams.set('tag', tag)
          return tmp.href
        }

        const blogDate = computed(() => {
          const tmp = page.post.matter?.data?.date
          return dayjs(tmp).utcOffset(8).format('YYYY-MM-DD')
        })

        async function getImgSize (imgSrc) {
          try {
            imgSrc = new URL(imgSrc).href
            return await new Promise((resolve, reject) => {
              const img = new Image()
              img.onload = function () {
                resolve({ height: this.height, width: this.width })
              }
              img.onerror = function (event) {
                console.error(event)
                reject(new Error('無法取得圖片大小'))
              }
              img.src = imgSrc
            })
          } catch (err) {
            throw new Error(`無法取得圖片大小: ${err.message}`)
          }
        }

        onMounted(async () => {
          await mermaid.run({ querySelector: '.mermaid' })

          // PhotoSwipe
          const postImgs = document.querySelectorAll('.blog-body img:not(a>img)')
          await Promise.all(_.map(postImgs, async postImg => {
            try {
              const { width, height } = await getImgSize(postImg.src)
              // console.log(`width: ${width}, height: ${height}, imgSrc: ${postImg.src}`)
              const pswpOpts = {
                dataSource: [{ src: postImg.src, width, height }],
                showHideAnimationType: 'none',
              }
              postImg.addEventListener('click', () => {
                pswpOpts.index = 0
                const pswp = new PhotoSwipe(pswpOpts)
                pswp.init()
              })
            } catch (err) {
              console.error(_.update(err, 'data.pswpPostImg', orig => orig ?? { imgSrc: postImg.src }))
            }
          }))
        })

        return { blogDate, getBlogTagUrl, page }
      },
    }).mount('#app')
